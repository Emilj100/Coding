<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, width=device-width">

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <link href="/static/styles.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <title>{% block title %}{% endblock %}</title>

    <style>
        /* Enkel styling til AI Fitness Coach chat-widget */
        #chat-widget {
            position: fixed;
            right: 20px;
            bottom: 20px;
            width: 300px;
            max-height: 400px;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: none; /* Skjult som standard */
            flex-direction: column;
            z-index: 1050;
        }
        #chat-widget header {
            background-color: #007bff;
            color: #fff;
            padding: 10px;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            cursor: pointer;
        }
        #chat-widget .messages {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
        }
        #chat-widget footer {
            display: flex;
            border-top: 1px solid #ccc;
        }
        #chat-widget footer input {
            flex: 1;
            border: none;
            padding: 10px;
        }
        #chat-widget footer button {
            background: #007bff;
            color: #fff;
            border: none;
            padding: 10px;
            cursor: pointer;
        }
        /* Toggle-knap for chat-widget */
        #chat-toggle {
            position: fixed;
            right: 20px;
            bottom: 20px;
            background-color: #007bff;
            color: #fff;
            padding: 10px 15px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 1100;
        }
    </style>
</head>
<body class="d-flex flex-column min-vh-100">
    <header class="bg-black">
        <div class="container">
            <div class="d-flex flex-wrap align-items-center justify-content-center justify-content-lg-start">
                <!-- Logo -->
                <a href="/" class="me-3">
                    <img src="/static/logo-white.png" alt="Logo" class="img-fluid" style="max-height: 150px;">
                </a>

                {% if session["user_id"] %}
                    <ul class="nav col-12 col-lg-auto me-lg-auto mb-2 justify-content-center mb-md-0">
                        <li><a href="/" class="nav-link px-2 text-white fs-5">Home</a></li>
                        <li><a href="/calorietracker" class="nav-link px-2 text-white fs-5">Calorie Tracker</a></li>
                        <li><a href="/traininglog" class="nav-link px-2 text-white fs-5">Traininglog</a></li>
                        <li><a href="/mealplan" class="nav-link px-2 text-white fs-5">Meal plan</a></li>
                    </ul>

                    <div class="text-end">
                        <a href="/logout" class="btn btn-outline-light me-2">Logout</a>
                        <a href="/dashboard" class="btn btn-primary">Dashboard</a>
                    </div>
                {% else %}
                    <ul class="nav col-12 col-lg-auto me-lg-auto mb-2 justify-content-center mb-md-0">
                        <li><a href="/" class="nav-link px-2 text-white fs-5">Home</a></li>
                    </ul>

                    <div class="text-end">
                        <a href="/login" class="btn btn-outline-light me-2">Login</a>
                        <a href="/register-part1" class="btn btn-primary">Sign up</a>
                    </div>
                {% endif %}
            </div>
        </div>
    </header>

    <main class="flex-grow-1">
        {% block main %}{% endblock %}
    </main>

    <footer class="bg-black text-white py-5 mt-auto">
        <div class="container">
            <div class="d-flex flex-wrap justify-content-between align-items-center">
                <p class="col-md-4 mb-0">© 2024 Company, Inc</p>
                <a href="/" class="col-md-4 d-flex align-items-center justify-content-center mb-3 mb-md-0 me-md-auto text-decoration-none">
                    <svg class="bi me-2" width="40" height="32"><use xlink:href="#bootstrap"></use></svg>
                </a>
                {% if session["user_id"] %}
                <ul class="nav col-md-4 justify-content-end">
                    <li class="nav-item"><a href="/" class="nav-link px-2 text-white">Home</a></li>
                    <li class="nav-item"><a href="/calorietracker" class="nav-link px-2 text-white">Calorie Tracker</a></li>
                    <li class="nav-item"><a href="/traininglog" class="nav-link px-2 text-white">Traininglog</a></li>
                    <li class="nav-item"><a href="/mealplan" class="nav-link px-2 text-white">Mealplan</a></li>
                </ul>
                {% else %}
                <ul class="nav col-md-4 justify-content-end">
                    <li class="nav-item"><a href="/" class="nav-link px-2 text-white">Home</a></li>
                    <li class="nav-item"><a href="/login" class="nav-link px-2 text-white">Login</a></li>
                    <li class="nav-item"><a href="/register" class="nav-link px-2 text-white">Sign up</a></li>
                </ul>
                {% endif %}
            </div>
        </div>
    </footer>

    <!-- Chat Toggle Button -->
    <div id="chat-toggle">Chat</div>

    <!-- Chat Widget -->
    <div id="chat-widget">
        <header id="chat-header">AI Fitness Coach</header>
        <div class="messages" id="chat-messages">
            <!-- Chat messages will appear here -->
        </div>
        <footer>
            <input type="text" id="chat-input" placeholder="Type your message..." />
            <button id="chat-send">Send</button>
        </footer>
    </div>

    <script src="/static/script.js"></script>
    <!-- Axios til AJAX-kald -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        // Toggle visning af chat-widget
        const chatToggle = document.getElementById('chat-toggle');
        const chatWidget = document.getElementById('chat-widget');
        chatToggle.addEventListener('click', () => {
            if (chatWidget.style.display === 'none' || chatWidget.style.display === '') {
                chatWidget.style.display = 'flex';
            } else {
                chatWidget.style.display = 'none';
            }
        });

        // Håndtering af beskeder i chat-widget
        const chatInput = document.getElementById('chat-input');
        const chatSend = document.getElementById('chat-send');
        const chatMessages = document.getElementById('chat-messages');

        function addMessage(sender, text) {
            const msgDiv = document.createElement('div');
            msgDiv.style.marginBottom = '10px';
            msgDiv.innerHTML = `<strong>${sender}:</strong> ${text}`;
            chatMessages.appendChild(msgDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        chatSend.addEventListener('click', () => {
            const message = chatInput.value.trim();
            if (!message) return;
            addMessage('You', message);
            chatInput.value = '';

            // Send beskeden til backend API via Axios
            axios.post('/api/fitness_coach', { message: message })
                .then(response => {
                    const reply = response.data.reply;
                    addMessage('Coach', reply);
                })
                .catch(error => {
                    console.error('Error:', error);
                    addMessage('Coach', 'Sorry, something went wrong.');
                });
        });

        // Send besked ved Enter-tast
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                chatSend.click();
            }
        });
    </script>
</body>
</html>
